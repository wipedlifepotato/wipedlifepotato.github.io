package rtl

import (
	"fmt"
	"os"

	"hz.tools/rf"
	"hz.tools/sdr"
	"hz.tools/sdr/rtl"
)

const (
	DEF_SAMPLE_RATE = 3200000
	WIN_SIZE        = 1024
	DEF_IQ_SIZE     = 1024
)

// TODO
type Rtl struct {
	sampleRate uint
	hz         int64
	Sdr        *rtl.Sdr
	gain       float32
	inited     bool
	ReadCloser sdr.ReadCloser
}

func (r *Rtl) SetSampleRate(sR uint) {
	r.sampleRate = sR
	r.Sdr.SetSampleRate(sR)
}

func (r *Rtl) SetGain(gain float32) {
	gainStages, _ := r.Sdr.GetGainStages()
	r.Sdr.SetGain(gainStages[0], gain) // ?

}

func (r *Rtl) Close() {
	r.ReadCloser.Close()
	r.Sdr.Close()
	r.ReadCloser = nil
	r.Sdr = nil
	r.inited = false
}

func (r *Rtl) ReInitSDR(cFreq int64) {
	r.Close()
	sdr, err := rtl.New(0, WIN_SIZE)
	if err != nil {
		panic(err)
	}
	r.Sdr = sdr
	err = r.Sdr.SetCenterFrequency(rf.Hz(cFreq)) // (446093000)
	if err != nil {
		fmt.Fprint(os.Stderr, "Can't to set freq of ", cFreq, " hz\n")
		//os.Exit(1)
	}
	r.ReadCloser, err = r.Sdr.StartRx()
	if err != nil {
		fmt.Fprintf(os.Stderr, "[rtl-sdr] Can't to startRx\n")
	}
	r.inited = true
}
func (r *Rtl) IQ2Q(mSamples [DEF_IQ_SIZE]complex128) [DEF_IQ_SIZE]float64 {
	var Q [DEF_IQ_SIZE]float64
	for i, sample := range mSamples {
		Q[i] = imag(sample) // Q = imagine
	}
	return Q
}
func (r *Rtl) IQ2I(mSamples [DEF_IQ_SIZE]complex128) [DEF_IQ_SIZE]float64 {
	var I [DEF_IQ_SIZE]float64
	for i, sample := range mSamples {
		I[i] = real(sample) // I = real
	}
	return I
}
func (r *Rtl) GetIQ() [DEF_IQ_SIZE]complex128 {
	mSamples := make(sdr.SamplesU8, 512) // 3200000) //
	r.ReadCloser.Read(mSamples)
	//fmt.Println(mSamples)
	mSamplesC64 := make(sdr.SamplesC64, 1024) //8129*8
	mSamples.ToC64(mSamplesC64)
	//fmt.Println(mSamplesC64)
	var mSamplesC128 [1024]complex128
	for i := 0; i < len(mSamplesC64); i++ {
		//		fmt.Println(mSamplesC64[i])
		mSamplesC128[i] = complex128(mSamplesC64[i])
	}
	return mSamplesC128
}

func (r *Rtl) InitSDR(cFreq int64, gain float32) {
	if r.inited {
		fmt.Fprintf(os.Stderr, "[rtl-sdr] Need ReInitSDR\n")
		return
	}
	if r.sampleRate == 0 {
		r.sampleRate = DEF_SAMPLE_RATE
	}
	r.gain = gain
	r.hz = cFreq

	sdr, err := rtl.New(0, WIN_SIZE)
	if err != nil {
		panic(err)
	}
	r.Sdr = sdr
	err = r.Sdr.SetCenterFrequency(rf.Hz(cFreq)) // (446093000)
	if err != nil {
		fmt.Fprint(os.Stderr, "Can't to set freq of ", cFreq, " hz\n")
		//os.Exit(1)
	}
	r.SetGain(gain)
	r.inited = true
	r.ReadCloser, err = r.Sdr.StartRx()
	if err != nil {
		fmt.Fprintf(os.Stderr, "[rtl-sdr] Can't to startRx\n")
	}
}
